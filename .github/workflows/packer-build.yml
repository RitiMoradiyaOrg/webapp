name: Build Custom AMI

on:
  push:
    branches:
      - main

jobs:
  build-ami:
    runs-on: ubuntu-latest
    name: Build and Share AMI
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: health_check_db_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm test
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: health_check_db_test
          DB_USER: postgres
          DB_PASSWORD: postgres

      - name: Create application artifact
        run: |
          echo "Creating webapp.zip artifact..."
          zip -r webapp.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "tests/*" \
            -x "*.md" \
            -x ".env*" \
            -x "packer.pkr.hcl" \
            -x "webapp.service"
          ls -lh webapp.zip

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: 'latest'

      - name: Initialize Packer
        run: packer init packer.pkr.hcl

      - name: Build AMI
        id: packer
        run: |
          echo "Building AMI..."
          packer build \
            -var "aws_region=${{ secrets.AWS_REGION }}" \
            -var "demo_account_id=${{ secrets.DEMO_ACCOUNT_ID }}" \
            packer.pkr.hcl | tee packer-output.txt
          
          # Extract AMI ID using regex pattern matching
          AMI_ID=$(grep -oP 'ami-[a-f0-9]+' packer-output.txt | head -n1)
          echo "New AMI ID: $AMI_ID"
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT

      #######################################
      # Instance Refresh Steps
      #######################################

      - name: Get Launch Template ID
        id: get-lt
        run: |
          echo "Finding Launch Template..."
          LT_ID=$(aws ec2 describe-launch-templates \
            --filters "Name=launch-template-name,Values=csye6225-vpc-launch-template" \
            --query 'LaunchTemplates[0].LaunchTemplateId' \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          echo "Launch Template ID: $LT_ID"
          echo "lt_id=$LT_ID" >> $GITHUB_OUTPUT

      - name: Create New Launch Template Version
        id: update-lt
        run: |
          echo "Creating new Launch Template version with AMI: ${{ steps.packer.outputs.ami_id }}"
          
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-id ${{ steps.get-lt.outputs.lt_id }} \
            --source-version '$Latest' \
            --launch-template-data "{\"ImageId\":\"${{ steps.packer.outputs.ami_id }}\"}" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          echo "New Launch Template Version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Set Launch Template Default Version
        run: |
          echo "Setting version ${{ steps.update-lt.outputs.version }} as default..."
          
          aws ec2 modify-launch-template \
            --launch-template-id ${{ steps.get-lt.outputs.lt_id }} \
            --default-version ${{ steps.update-lt.outputs.version }} \
            --region ${{ secrets.AWS_REGION }}
          
          echo "âœ“ Default version updated successfully"

      - name: Get Auto Scaling Group Name
        id: get-asg
        run: |
          echo "Finding Auto Scaling Group..."
          ASG_NAME=$(aws autoscaling describe-auto-scaling-groups \
            --query "AutoScalingGroups[?AutoScalingGroupName=='csye6225-vpc-asg'].AutoScalingGroupName" \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          echo "Auto Scaling Group Name: $ASG_NAME"
          echo "asg_name=$ASG_NAME" >> $GITHUB_OUTPUT

      - name: Start Instance Refresh
        id: start-refresh
        run: |
          echo "Starting instance refresh for ASG: ${{ steps.get-asg.outputs.asg_name }}"
          
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ steps.get-asg.outputs.asg_name }} \
            --preferences '{
              "MinHealthyPercentage": 80,
              "InstanceWarmup": 300,
              "CheckpointPercentages": [50, 100],
              "CheckpointDelay": 300
            }' \
            --query 'InstanceRefreshId' \
            --output text \
            --region ${{ secrets.AWS_REGION }})
          
          echo "Instance Refresh ID: $REFRESH_ID"
          echo "refresh_id=$REFRESH_ID" >> $GITHUB_OUTPUT

      - name: Wait for Instance Refresh to Complete
        run: |
          echo "Waiting for instance refresh to complete..."
          echo "Refresh ID: ${{ steps.start-refresh.outputs.refresh_id }}"
          
          aws autoscaling wait instance-refresh-complete \
            --auto-scaling-group-name ${{ steps.get-asg.outputs.asg_name }} \
            --instance-refresh-ids ${{ steps.start-refresh.outputs.refresh_id }} \
            --region ${{ secrets.AWS_REGION }} \
            --cli-read-timeout 1200
          
          echo "âœ“ Instance refresh completed successfully!"

      - name: Deployment Summary
        if: always()
        run: |
          echo "========================================="
          echo "ðŸŽ‰ DEPLOYMENT SUMMARY"
          echo "========================================="
          echo "New AMI ID: ${{ steps.packer.outputs.ami_id }}"
          echo "Launch Template ID: ${{ steps.get-lt.outputs.lt_id }}"
          echo "Launch Template Version: ${{ steps.update-lt.outputs.version }}"
          echo "Auto Scaling Group: ${{ steps.get-asg.outputs.asg_name }}"
          echo "Instance Refresh ID: ${{ steps.start-refresh.outputs.refresh_id }}"
          echo "========================================="